---
title: "MWPALEO-Data analysis"
author: "Olivia Burge"
date: "26/06/2018"
output: 
  ioslides_presentation:
    widescreen: true
    fig_height: 3
    css: css/paleoStyles.css
    logo: assets/img/mwlr-logo-800.png
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
require(rioja)
require(analogue)
require(vegan)
require(tidyverse)

```

## Overview

### This session will try to mimic workflows e.g.

- Getting data in (again `r emo::ji("smile")`) 
- Doing an analysis (e.g. ordination)
- Plotting the analysis
- Saving the plot and the analysis output 

## Overview cont

- If anyone has any specific requests
- we can try some live coding `r emo::ji("grimacing face")``r emo::ji("grimacing face")`
- otherwise we will work through as many as 
- NB re plotting stratigraphic diagrams - nothing as specialised and all-encompassing as non-R options. 

## Overview of *packages* available in R

<div class="columns-2">
- Packages are just collections of *functions*
- Functions are just bits of code where you can swap the inputs around
- e.g. read.csv is a function, and the input you change is the filename. 

<div><img src = "assets/img/functionScreenshot.png" height = 600></div>

## Overview of *packages* available in R

- **neotoma** - an interface to the neotoma paleo database. You can download data from within R. By ROpenSci (consortium) & Simon Goring
- **rioja** - most useful as it has a `read.Tilia` function allowing old Tilia datasets to be read in. By Steve Juggins. Also some functions for transfer functions, plotting, constrained heirarchical clustering (zonation)
- **analogue** - More transfer functions and analogue techniques
- **vegan** - multivariate data analysis used a lot by neoecologists too. We will use this today for the ordinations. 
- **paleofire** - get data out of the Global Charcoal Database and analyse it


## New packages required [group install]

```{r, eval=FALSE, echo = TRUE}

# if you don't have any of the packages below
# use the following examples to install them
install.packages(analogue)
install.packages(rioja)

# now load the packages: 

# for multivariate analyses
require(vegan)

# for data manipulation
require(tidyverse)

# for examples of stratigraphic plot functionality
require(analogue)
require(rioja)


```


## Read in data

- Where is the file? 
- Where is our working directory? 
- What is the path from the working directory to the file?

```{r, echo = TRUE}
getwd()
eweburnCounts <- read.csv(
  file = "../1-folders-spreadsheets-organisingData/data/EWEBURN-9711PWKA.csv"
  )

head(eweburnCounts)
```


## Read in data cont

- the ".." in the previous slide `../1-folders` means go up out of the current working directory one level
- we need to go up a level 

## It looks different to Tilia :-/

Data comes in "long" and "wide" forms. **And** you need to know how to convert between both! 

### Why? 
<br>
Because some packages require the long format and some require the wide. No escape! Luckily the code is relatively easy. 

## Wide and long

- Conceptually, "long" data has a column for a category (e.g. *species*) and a column for the value for that species (e.g. *counts*)

- Whereas "wide" data has the values for each category under the category name

- NB I use "*category*" here as it seems more intuitive but the help page uses the term "*key*"

## Convert wide to long - concept

We use the `gather()` function as so:

`DATASET %>% gather(key = "species", value = "counts", colNameA:colNameZ)`

You can change the "species" and "counts" to whatever names you want for the columns. Just note that whatever you choose to use needs to be surrounded by quotes (as above). [help page discussion `?gather`]

## Wide to long - example

(1) Please read in the mites dataset (from package vegan, with one amendment) 

```{r, echo = TRUE}
mites <- read.csv("data/vegan_mites.csv")
head(mites, 1)
```

We need to decide which columns are to be included in the species column

## Wide and long - example

```{r echo = TRUE}

longMites <- mites %>% 
  gather(key = "species", value = "counts", 
         Brachy:Trimalc2)

```

## Long data histogram

```{r echo = TRUE, message = FALSE, warning=FALSE}
shortishMites <- mites %>% 
  gather(key = "species", value = "countPerPlot", 
         Brachy:Trimalc2) %>%
  filter(species %in% c("Brachy", "HPAV", "PWIL")) 

ggplot(data = shortishMites, aes(x = countPerPlot)) +
  geom_histogram() +
  facet_wrap(~ species)

```

## Long data histogram

- What would have happened if we didn't use `filter` first? 
- Have a go. 

## One more diversion: summaries 

- Summarising things - by species, for example - is often done best in long format. 
<br>
- Sometimes we want a summary for the whole dataset, and sometimes we want it _**by a group**_

## Summarising concept

### Lots of summary functions in R
- `mean()` (we use this below)
- `sd()`
- `min()`
- `max()`

```{r eval = FALSE, echo = TRUE}

DATASET %>% summarise(NEW_COL_NAME = mean(EXISTING_COLUMN_NAME))

DATASET %>% group_by(GROUP_COLUMN_NAME) %>%
  summarise(NEW_COL_NAME = mean(EXISTING_COLUMN_NAME)
```

## Summarising example (1)

```{r echo = TRUE}

longMites %>% # this is the object we made a bit earlier
  summarise(meanCount = mean(counts)) # mean count across all plots and all species

```


## Summarising example (2)

```{r echo = TRUE}

longMites %>% # this is the object we made a bit earlier
  group_by(species) %>% # adding this line means we'll get a summary by each species
  summarise(meanCount = mean(counts)) # mean count for each species

```

## Summarising example (3)


```{r echo = TRUE}

longMites %>% # this is the object we made a bit earlier
  filter(plot < 6) %>% # take only plots 1 through 5
  group_by(species) %>% # adding this line means we'll get a summary by each species
  summarise(meanCount = mean(counts)) # mean count for each species

```

## Back to business: long to wide concept

- We use the `spread()` function to go from long to wide. 
- Here we only have to say the 'key' and 'value' columns

```{r, echo = TRUE, eval = FALSE}
DATASET %>%
  spread(key = SPECIES, value = N_COUNTED_PER_PLOT)
```

## Long to wide example

```{r echo = TRUE}
head(longMites, 2)
longMites %>%
  spread(key = species, value = counts)
```

## Long to wide example (2)

```{r echo = TRUE}

longMites %>%
  spread(key = species, value = counts, 
         sep = "_")
```

## Back to Eweburn and ordinating

- You can only have one "key" column (ie species). 
- But in this dataset we have more than one key column
- In this case I've chosen to keep the "FullNames"

```{r, echo = TRUE}
eweburnWide <- eweburnCounts %>% 
  filter(!Sums %in% c("W", "F")) %>%
  select(FullNames, counts, Depths) %>% 
  spread(FullNames, counts) %>%
  data.frame()
eweburnWide
```

## Which species to go in the ordination? {.smaller}

- Best to look at this on your own screen - there's a lot!

```{r, echo = TRUE, eval = FALSE}

names(eweburnWide)

```

## Select the right columns before ordination

- Need to drop the depth column, summary columns, charcoal counts


```{r, echo = TRUE}
eweVeg <- eweburnWide %>% 
  select(X.iAlnus : X.Poa..40um.not..iChionochloa)
names(eweVeg)
```

## After all the tidying: *ordination* {.smaller}

- we give the function the name of the data object (`comm`)
- the distance we want to use (`distance`)
- the number of dimensions to use (`k`)

```{r, echo = TRUE}
ord <- metaMDS(comm = eweVeg, distance = "jaccard",
               k = 2)
```

## Ordination basic results (1)

```{r echo = TRUE}
ord
```

## Ordination basic results (2)

```{r echo = TRUE, fig.height = 5}
stressplot(ord)
```

## Ordination plotting

- there is the *easy* way to do this. And the *hard* way

```{r echo = TRUE, fig.height=4}
# the easy way
plot(ord, "species")
text(ord, "sites")

```

## Ordination plotting

```{r, echo=TRUE, fig.height = 5}
# just the sites (ie depths which were sampled)
plot(ord, "sites")
```

## The difficult way

```{r, echo = TRUE}

plottingDat <- data.frame(
  eweburnWide %>% select(Depths), 
  scores(ord, "sites"))

head(plottingDat)

```

## The difficult way 

```{r, echo = TRUE}
plottingDat <- plottingDat %>%
  mutate(DepthCategorical = ifelse(Depths < 70, "Shallow", "Deep"))

ordPlot <- ggplot(plottingDat, aes(x = NMDS1, y = NMDS2)) +
  geom_point(aes(colour = DepthCategorical), size = 2)  +
  coord_equal()
ordPlot

```

## Customising 

```{r, echo = TRUE, fig.height = 4}

ordPlot2 <- ordPlot + theme_minimal() +
  theme(legend.position = "bottom")
ordPlot2

```

## Customising

```{r, echo = TRUE, fig.height = 4}
ordPlot2 + 
  scale_colour_manual(values = c(
    "darkblue", "orange"
  ))
```
